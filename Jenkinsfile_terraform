pipeline {
    agent any

    environment {
        REPO_DIR = "${JENKINS_HOME}/workspace/${JOB_NAME}/repo"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Clone or Update Git Repository') {
            steps {
                script {
                    // Verifică dacă repo-ul există deja
                    def repoExists = fileExists(REPO_DIR)

                    if (repoExists) {
                        // Dacă există, actualizează cu git pull
                        sh "cd ${REPO_DIR} && git pull"
                    } else {
                        // Dacă nu există, clonare inițială
                        sh "mkdir -p ${REPO_DIR}"
                        sh "git clone https://github.com/cristianbanto/Jenkins-learning.git ${REPO_DIR}"
                    }
                }
            }
        }

        stage('Terraform Init') {
            steps {
                script {
                    // Specifică directorul cu fișierele Terraform
                    def terraformDir = "${JENKINS_HOME}/workspace/${JOB_NAME}/repo/terraform/"

                    // Navighează în directorul Terraform
                    dir(terraformDir) {
                        // Initializează Terraform
                        sh 'terraform init'
                    }
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                script {
                    // Specifică directorul cu fișierele Terraform
                    def terraformDir = "${JENKINS_HOME}/workspace/${JOB_NAME}/repo/terraform/"

                    // Navighează în directorul Terraform
                    dir(terraformDir) {
                        // Aplică schimbările cu Terraform
                            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                            sh 'echo "Terraform plan"'
                            sh 'terraform plan'
                        }
                    }
                }
            }
        }        

        stage('Terraform Apply') {
            steps {
                script {
                    // Specifică directorul cu fișierele Terraform
                    def terraformDir = "${JENKINS_HOME}/workspace/${JOB_NAME}/repo/terraform/"

                    // Navighează în directorul Terraform
                    dir(terraformDir) {
                        // Aplică schimbările cu Terraform
                            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                            sh 'echo "Terraform plan first"'
                            sh 'terraform plan'
                            sh 'terraform apply -auto-approve'
                        }
                    }
                }
            }
        }

        stage('Terraform Destroy if case was checked') {
            steps {
                script {
                    // Ask user for confirmation
                    def userConfirm = input(
                        message: 'Do you want to destroy the infrastructure?',
                        parameters: [booleanParam(defaultValue: false, description: 'Check to destroy')]
                    )

                    if (userConfirm) {
                        // Terraform destroy
                        echo "Destroying Terraform resources..."
                        sh 'terraform destroy -auto-approve'
                    } else {
                        echo "Infrastructure will not be destroyed."
                    }
                }
            }
        }
    }
}
