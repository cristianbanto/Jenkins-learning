pipeline {
    agent any

    environment {
        AWS_S3_BUCKET = 'security-test-bucket-cristi'
        AWS_DEFAULT_REGION = 'eu-west-1'
    }

    stages {
                stage('Security scan with ClamAV') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "clamav-report-${timestamp}.txt"
                    def localReportPath = "/home/cristi/scan/${reportFileName}"

                    sh "chmod +w ${localReportPath}"
                    sh "clamscan -r /home/cristi/scan --log=${localReportPath}"
                    

                    sh "cat ${localReportPath}"
                }
            }
        }

        stage('Save report to S3') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "clamav-report-${timestamp}.txt"
                    def localReportPath = "/home/cristi/scan/${reportFileName}"

                    // Copierea raportului Ã®n S3
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                        sh "aws s3 cp ${localReportPath} s3://${AWS_S3_BUCKET}/${reportFileName}"
                    }
                }
            }
        }
    }
}