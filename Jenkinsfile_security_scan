pipeline {
    agent any

    environment {
        AWS_S3_BUCKET = 'security-test-bucket-cristi'
        AWS_DEFAULT_REGION = 'eu-west-1'
    }

    stages {
        stage('Security scan with ClamAV') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "clamav-report-${timestamp}.txt"
                    def localReportPath = "${JENKINS_HOME}/workspace/${JOB_NAME}/${BUILD_NUMBER}/${reportFileName}"
                    def localReportDir = localReportPath.replaceAll("/[^/]+$", "")  // Extrage directorul din calea fișierului

                    sh "mkdir -p ${localReportDir}"
                    sh "clamscan -r /home/cristi/scan > ${localReportPath}"
                    

                    sh "cat ${localReportPath}"
                }
            }
        }

        stage('Save report to S3') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "clamav-report-${timestamp}.txt"
                    def localReportPath = "${JENKINS_HOME}/workspace/${JOB_NAME}/${BUILD_NUMBER}/${reportFileName}"

                    // Copierea raportului în S3
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                        sh "aws s3 cp ${localReportPath} s3://${AWS_S3_BUCKET}/${reportFileName}"
                    }
                }
            }
        }
    }
}