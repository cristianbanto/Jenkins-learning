pipeline {
    agent any

    environment {
        AWS_S3_BUCKET = 'security-test-bucket-cristi'
        AWS_DEFAULT_REGION = 'eu-west-1'
    }

    stages {
        stage('Security scan with Maldet') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "maldet-report-${timestamp}.txt"
                    def localReportPath = "/home/cristi/scan/${reportFileName}"

                    sh "maldet -a /home/cristi/scan -o ${localReportPath}"

                    sh "cat ${localReportPath}"

                }
            }
        }

        stage('Save report to S3') {
            steps {
                script {
                    def timestamp = new Date().format("yyyyMMddHHmmss")
                    def reportFileName = "maldet-report-${timestamp}.txt"
                    def localReportPath = "/home/cristi/scan/${reportFileName}"

                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credentials', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                        sh "aws s3 cp ${localReportPath} s3://${AWS_S3_BUCKET}/${reportFileName}"
                    }
                }
            }
        }
    }
}
